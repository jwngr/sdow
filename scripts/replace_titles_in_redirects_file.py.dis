"""
Replaces page titles in the redirects file with their corresponding targetIDs.

Output is written to stdout.
"""

import io
import sys
import gzip

# Validate input arguments.
if len(sys.argv) < 3:
  print('[ERROR] Not enough arguments provided!')
  print('[INFO] Usage: {0} <targets_file> <redirects_file>'.format(sys.argv[0]))
  sys.exit()

TARGETS_FILE = sys.argv[1]
REDIRECTS_FILE = sys.argv[2]

if not TARGETS_FILE.endswith('.gz'):
  print('[ERROR] Targets file must be gzipped.')
  sys.exit()

if not REDIRECTS_FILE.endswith('.gz'):
  print('[ERROR] Redirects file must be gzipped.')
  sys.exit()

# Create a set of all targetIDs and a dictionary of target titles to their corresponding IDs.
ALL_TARGET_IDS = set()
TARGET_TITLES_TO_IDS = {}
for line in io.BufferedReader(gzip.open(TARGETS_FILE, 'rb')):
  print("LALIGNE",line.rstrip(b'\n').split(b'\t'))
  [page_id, page_title,_] = line.rstrip(b'\n').split(b'\t')
  ALL_TARGET_IDS.add(page_id)
  TARGET_TITLES_TO_IDS[page_title] = page_id

# Create a dictionary of redirects, replace page titles in the redirects file with their
# corresponding IDs and ignoring pages which do not exist.
REDIRECTS = {}
for line in io.BufferedReader(gzip.open(REDIRECTS_FILE, 'rb')):
  [source_page_id, target_page_title] = line.rstrip(b'\n').split(b'\t')

  source_page_exists = source_page_id in ALL_TARGET_IDS
  target_page_id = TARGET_TITLES_TO_IDS.get(target_page_title)

  if source_page_exists and target_page_id is not None:
    REDIRECTS[source_page_id] = target_page_id

# Loop through the redirects dictionary and remove redirects which redirect to another redirect,
# writing the remaining redirects to stdout.
for source_page_id, target_page_id in REDIRECTS.items():
  start_target_page_id = target_page_id

  redirected_count = 0
  while target_page_id in REDIRECTS:
    target_page_id = REDIRECTS[target_page_id]

    redirected_count += 1

    # Break out if there is a circular path, meaning the redirects only point to other redirects,
    # not an acutal page.
    if target_page_id == start_target_page_id or redirected_count > 100:
      target_page_id = None

  if target_page_id is not None:
    print(b'\t'.join([source_page_id, target_page_id]).decode())
